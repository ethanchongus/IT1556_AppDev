{% extends "base_admin.html" if editing else "base.html" %}
{% block title %}{{ "Update Details" if editing else "Register New Card Information" }}{% endblock %}

{% block content %}
<div class="container mx-auto py-8 max-w-lg">
    <h1 class="text-xl font-bold mb-8">{{ "Update Details" if editing else "Register New Card Information" }}</h1>
    
    <!-- Display Activity Summary -->
    {% if cart %}
    <div class="mb-8">
        <h2 class="text-lg font-semibold">Activity Summary</h2>
        <ul class="list-disc pl-5">
            {% for item in cart %}
            <li>{{ item.name }} - SGD {{ item.price }} x {{ item.quantity }} = SGD {{ item.price * item.quantity }}</li>
            {% endfor %}
        </ul>
        <p class="font-bold mt-4">Total: SGD {{ total_price }}</p>
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('admin.edit_payment', payment_id=form_data.id) if editing else '/payment/' }}" class="space-y-6">
        {% if errors %}
        <div class="text-red-500 mb-4">
            {% for error in errors.values() %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Card Number -->
        <div class="flex items-center mb-4">
            <label for="card_number" class="w-48 text-right text-sm font-medium pr-4">Card Number*</label>
            <input type="text" id="card_number" name="card_number" placeholder="XXXX XXXX XXXX XXXX"
                   value="{{ form_data.card_number if form_data else '' }}"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-500 focus:outline-none {% if errors.card_number %}border-red-500{% endif %}" required>
        </div>

        <!-- Expiration Date -->
        <div class="flex items-center mb-4">
            <label for="expiry_date" class="w-48 text-right text-sm font-medium pr-4">Expiration Date*</label>
            <input type="text" id="expiry_date" name="expiry_date" placeholder="MM/YY"
                   value="{{ form_data.expiry_date if form_data else '' }}"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-500 focus:outline-none {% if errors.expiry_date %}border-red-500{% endif %}" required>
        </div>

        <!-- CVV -->
        <div class="flex items-center mb-4">
            <label for="cvv" class="w-48 text-right text-sm font-medium pr-4">CVV*</label>
            <input type="text" id="cvv" name="cvv" placeholder="3 digits"
                   value="{{ form_data.cvv if form_data else '' }}"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-500 focus:outline-none {% if errors.cvv %}border-red-500{% endif %}" required>
        </div>

        <!-- Full Name -->
        <div class="flex items-center mb-4">
            <label for="name" class="w-48 text-right text-sm font-medium pr-4">Full Name*</label>
            <input type="text" id="name" name="name"
                   value="{{ form_data.name if form_data else '' }}"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-500 focus:outline-none {% if errors.name %}border-red-500{% endif %}" required>
        </div>

        <!-- Email -->
        <div class="flex items-center mb-4">
            <label for="email" class="w-48 text-right text-sm font-medium pr-4">Email*</label>
            <input type="email" id="email" name="email" placeholder="example@email.com"
                   value="{{ form_data.email if form_data else '' }}"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-500 focus:outline-none {% if errors.email %}border-red-500{% endif %}" required>
        </div>

        <!-- Buttons -->
        <div class="flex justify-end space-x-4 pt-4">
            <button type="submit" class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800">{{ "Update" if editing else "Continue" }}</button>
            <a href="{{ url_for('payment.customer_checkout') }}" class="bg-white border border-black text-black px-6 py-2 rounded hover:bg-gray-100">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Auto-spacing for card number (every 4 digits) and limit to 16 digits
    document.getElementById('card_number').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        value = value.slice(0, 16); // Limit to 16 digits
        value = value.match(/.{1,4}/g)?.join(' ') || ''; // Group digits in fours
        e.target.value = value;
    });

    // Limit CVV to 3 digits
    document.getElementById('cvv').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        e.target.value = value.slice(0, 3); // Limit to 3 digits
    });

    // Auto-formatting for expiration date (MM/YY)
    document.getElementById('expiry_date').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length >= 2) {
            value = value.slice(0, 2) + '/' + value.slice(2); // Add slash after MM
        }
        e.target.value = value.slice(0, 5); // Limit to 5 characters (MM/YY)
    });
</script>
{% endblock %}